<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E.CO PG Run Data Collection Form - MPL</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
</head>
<body>

<div class="login-page-wrapper">
  <div class="login-container" id="loginContainer">
    <div class="login-header">
      <i class="material-icons login-icon">shield</i>
      <h2>Secure Login</h2>
    </div>
    <form id="loginForm">
      <div class="input-field">
        <i class="material-icons prefix">account_circle</i>
        <input type="text" id="username" name="username" required>
        <label for="username">Username</label>
        <span class="error-message" id="username-error"></span>
      </div>

      <div class="input-field">
        <i class="material-icons prefix">lock</i>
        <input type="password" id="password" name="password" required>
        <label for="password">Password</label>
        <span class="error-message" id="password-error"></span>
      </div>

      <button type="submit" class="btn waves-effect waves-light login-btn"><i class="material-icons left">login</i>Login</button>
      <div class="login-message" id="login-status"></div>
    </form>
  </div>
</div>

<div id="mainContent" style="display: none;">
  <div class="container">
    <div class="header-buttons">
      <button type="button" id="showFormBtn" class="btn primary-btn active-tab">Data Entry Form</button>
      <button type="button" id="showReportBtn" class="btn primary-btn">View Reports</button>
    </div>
    <div id="formContainer">
      <div class="form-header">
          <h2>E.CO PG Run Data Collection Form-MPL</h2>
          <span id="loggedInUserDisplay" class="logged-in-user"></span>
      </div>
      <form id="pgForm" novalidate>
        <div class="card">
          <div class="card-content">
            <div class="input-field">
              <input type="text" id="ttNumber" name="ttNumber" maxlength="7" inputmode="numeric">
              <label for="ttNumber">TT Number (7 digits)</label>
              <span class="error-message" id="ttNumber-error"></span>
            </div>

            <div class="input-field">
              <select id="operatorName" name="operatorName">
                <option value="" disabled selected>Select an operator</option>
                <option value="GP">GP</option>
                <option value="BL">BL</option>
                <option value="ROBI">ROBI</option>
              </select>
              <label for="operatorName" class="active select-label">Operator Name</label>
              <span class="error-message" id="operatorName-error"></span>
            </div>

            <div class="input-field">
              <select id="siteDropdown" name="site"></select>
              <label for="siteDropdown" class="active select-label">Select Site</label>
              <span class="error-message" id="siteDropdown-error"></span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-content">
            <div class="input-field">
              <select id="pgOperatorDropdown" name="pgOperator"></select>
              <label for="pgOperatorDropdown" class="active select-label">Select PG Operator Name</label>
              <span class="error-message" id="pgOperatorDropdown-error"></span>
            </div>

            <div class="input-field">
              <select id="teamLeaderDropdown" name="teamLeader"></select>
              <label for="teamLeaderDropdown" class="active select-label">Select Team Leader Name</label>
              <span class="error-message" id="teamLeaderDropdown-error"></span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-content">
            <div class="input-field">
              <select id="selectOption" name="selectOption">
                <option value="" disabled selected>Select an option</option>
                <option value="Misscall TT">Misscall TT</option>
                <option value="PG Run">PG Run</option>
              </select>
              <label for="selectOption" class="active select-label">Select Option</label>
              <span class="error-message" id="selectOption-error"></span>
            </div>
          </div>
        </div>

        <div id="misscallTTFields" style="display: none;" class="conditional-section">
          <div class="card">
            <div class="card-content">
              <div class="input-field">
                <select id="siteAttend" name="siteAttend">
                  <option value="" disabled selected>Select an option</option>
                  <option value="YES">YES</option>
                <option value="NO">NO</option>
                </select>
                <label for="siteAttend" class="active select-label">Site Attend</label>
                <span class="error-message" id="siteAttend-error"></span>
              </div>
            </div>
          </div>
          <div id="siteAttendDateTimeField" style="display: none;">
            <div class="card">
              <div class="card-content">
                <div class="input-field">
                  <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" class="input-material" />
                  <label for="siteAttendDateTime" class="active">Site Attend Date & Time</label>
                  <span class="error-message" id="siteAttendDateTime-error"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="pgRunFields" style="display: none;" class="conditional-section">
          <div id="pgEventsContainer">
            </div>
          <div class="add-event-wrapper">
              <button type="button" id="addEventBtn" class="btn waves-effect waves-light add-button" style="display: none;"><i class="material-icons left">add_circle_outline</i>Add Event</button>
          </div>
        </div>

        <button type="submit" class="btn waves-effect waves-light primary-submit-btn"><i class="material-icons left">send</i>Submit</button>
          <div class="progress-bar loading" style="display: none;">
              <div class="indeterminate"></div>
          </div>
          <div id="submissionStatus" class="submission-status-message" style="display: none;"></div>
      </form>
    </div>

    <div id="reportContainer" style="display: none;">
      <div class="form-header">
          <h2>E.CO PG Run Data Reports</h2>
      </div>
      <div class="card">
        <div class="card-content">
          <div class="input-field">
            <input type="date" id="startDate" name="startDate" class="input-material" />
            <label for="startDate" class="active">Start Date</label>
            <span class="error-message" id="startDate-error"></span>
          </div>
          <div class="input-field">
            <input type="date" id="endDate" name="endDate" class="input-material" />
            <label for="endDate" class="active">End Date</label>
            <span class="error-message" id="endDate-error"></span>
          </div>
          <div class="report-buttons">
            <button type="button" id="generateReportBtn" class="btn waves-effect waves-light primary-submit-btn"><i class="material-icons left">insert_chart</i>Generate Report</button>
            <button type="button" id="exportExcelBtn" class="btn waves-effect waves-light secondary-btn" style="display: none;"><i class="material-icons left">cloud_download</i>Export to Excel</button>
          </div>
          <div class="progress-bar loading" style="display: none;" id="reportLoading">
              <div class="indeterminate"></div>
          </div>
          <div id="reportStatus" class="submission-status-message" style="display: none;"></div>
        </div>
      </div>

      <div id="reportResults" class="card" style="display: none;">
        <div class="card-content">
          <div class="report-table-container">
            <table id="reportTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>TT Number</th>
                  <th>Operator</th>
                  <th>Site</th>
                  <th>PG Operator</th>
                  <th>Team Leader</th>
                  <th>Option Selected</th>
                  <th>Site Attend</th>
                  <th>Site Attend DT</th>
                  <th>PG Start DT</th>
                  <th>PG Stop DT</th>
                  <th>Fuel Used From</th>
                  <th>Entry By</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer-info">
  <p>Powered and Developed By<br>
  <strong>Rakibul Islam Ratul</strong><br>
  <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script>
  $(document).ready(function () {
    console.log("Document ready."); // Matches example log

    const MAX_EVENTS = 10;
    let eventCount = 0;
    let loggedInUsername = '';
    let employeeData = [];

    // --- Helper Functions ---
    function M_updateTextFields() {
        $('input[type=text], input[type=password], input[type=email], input[type=url], input[type=tel], input[type=number], input[type=search], textarea').each(function (index, element) {
            const $this = $(element);
            const $label = $this.siblings('label');
            if ($this.val().length > 0 || $this.attr('placeholder') !== undefined || $this.is(':focus')) {
                $label.addClass('active');
            } else if (!$this.is('[readonly]')) {
                $label.removeClass('active');
            }
        });
        $('select').each(function() {
            const $this = $(this);
            const $label = $this.siblings('label.select-label');
            if ($this.val() && $this.val() !== "") {
                 $label.addClass('active');
            }
        });
    }

    function getCurrentDateTimeLocal() {
        const now = new Date();
        const tzOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - tzOffset)).toISOString().slice(0, 16);
        return localISOTime;
    }

    function parseDateTime(datetimeStr) {
        if (!datetimeStr) return null;
        const date = new Date(datetimeStr);
        return isNaN(date.getTime()) ? null : date;
    }

    function displayMessage(elementId, message, isError) {
        const el = $(`#${elementId}`);
        if (el.length) {
            el.text(message).removeClass('success error').addClass(isError ? 'error' : 'success').fadeIn();
            if(isError && elementId === 'submissionStatus') {
                 setTimeout(() => el.fadeOut(), 5000);
            } else if (!isError && elementId === 'submissionStatus') {
                 setTimeout(() => el.fadeOut(), 3000);
            }
        }
    }

    function displayError(fieldId, message) {
        const errorSpan = $(`#${fieldId}-error`);
        const fieldElement = $(`#${fieldId}`);
        if (!fieldElement.length) return;

        if (message) {
            if (errorSpan.length) errorSpan.text(message).show();
            fieldElement.addClass('invalid');
            if (fieldElement.is('select') && fieldElement.data('select2')) {
                 fieldElement.next('.select2-container').find('.select2-selection--single').addClass('invalid-select2');
            }
        } else {
            if (errorSpan.length) errorSpan.text('').hide();
            fieldElement.removeClass('invalid');
            if (fieldElement.is('select') && fieldElement.data('select2')) {
                 fieldElement.next('.select2-container').find('.select2-selection--single').removeClass('invalid-select2');
            }
        }
    }

    $('#ttNumber').on('input', function() {
        let value = $(this).val();
        value = value.replace(/[^0-9]/g, '');
        if (value.length > 7) {
            value = value.slice(0, 7);
        }
        $(this).val(value);
        displayError('ttNumber', '');
    });


    function validateField(fieldId, customMessage = 'This field is mandatory.') {
        const value = $(`#${fieldId}`).val();
        if (!value || (Array.isArray(value) && value.length === 0)) {
            displayError(fieldId, customMessage);
            return false;
        } else {
            displayError(fieldId, '');
            return true;
        }
    }

    function validateAllConditionalFields() {
        const selectOption = $('#selectOption').val();
        let allValid = true;

        if (selectOption === 'Misscall TT' && $('#misscallTTFields').is(':visible')) {
            if (!validateField('siteAttend')) allValid = false;
            const siteAttend = $('#siteAttend').val();
            if (siteAttend === 'YES' && $('#siteAttendDateTimeField').is(':visible')) {
                const siteAttendDateTimeVal = $('#siteAttendDateTime').val();
                if (!siteAttendDateTimeVal) {
                    displayError('siteAttendDateTime', 'Date & Time is mandatory when Site Attend is YES.');
                    allValid = false;
                } else {
                    const siteAttendDateTime = parseDateTime(siteAttendDateTimeVal);
                    const now = new Date();
                    if (!siteAttendDateTime || siteAttendDateTime > now) {
                         displayError('siteAttendDateTime', 'Invalid or future date/time.');
                         allValid = false;
                    } else {
                        displayError('siteAttendDateTime', '');
                    }
                }
            } else {
                 displayError('siteAttendDateTime', '');
            }
        } else {
             displayError('siteAttend', '');
            displayError('siteAttendDateTime', '');
        }

        if (selectOption === 'PG Run' && $('#pgRunFields').is(':visible')) {
            let previousEventStop = null;
            if ($('#pgEventsContainer .event-card').length === 0 && eventCount > 0) {
            }
            $('#pgEventsContainer .event-card').each(function(index) {
                const eventNumber = $(this).data('event-number');
                const pgStartId = `pgStart${eventNumber}`;
                const pgStopId = `pgStop${eventNumber}`;
                const fuelUsedFromId = `fuelUsedFrom${eventNumber}`;
                const pgStartVal = $(`#${pgStartId}`).val();
                const pgStopVal = $(`#${pgStopId}`).val();
                const fuelUsedFromVal = $(`#${fuelUsedFromId}`).val();
                const pgStart = parseDateTime(pgStartVal);
                const pgStop = parseDateTime(pgStopVal);
                const now = new Date();
                let currentEventValid = true;

                if (pgStartVal || pgStopVal || fuelUsedFromVal || index === 0) {
                    if (!pgStartVal) { displayError(pgStartId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(pgStartId, ''); }
                    if (!pgStopVal) { displayError(pgStopId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(pgStopId, ''); }
                    if (!fuelUsedFromVal) { displayError(fuelUsedFromId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(fuelUsedFromId, ''); }

                    if (pgStart && pgStop) {
                         if (pgStop <= pgStart) { displayError(pgStopId, 'Stop time must be after Start time.'); allValid = false; currentEventValid = false; }
                         if (pgStart > now) { displayError(pgStartId, 'Start time cannot be in the future.'); allValid = false; currentEventValid = false; }
                         if (pgStop > now) { displayError(pgStopId, 'Stop time cannot be in the future.'); allValid = false; currentEventValid = false; }
                         if (previousEventStop && pgStart <= previousEventStop) { displayError(pgStartId, `Must be after Event ${index}'s Stop.`); allValid = false; currentEventValid = false; }

                         if (currentEventValid) { previousEventStop = pgStop; }
                         else { previousEventStop = null; }
                    } else { previousEventStop = null; }
                } else {
                     displayError(pgStartId, '');
                     displayError(pgStopId, '');
                     displayError(fuelUsedFromId, '');
                }
            });
        } else {
             $('#pgEventsContainer .event-card').each(function() {
                 const eventNumber = $(this).data('event-number');
                 displayError(`pgStart${eventNumber}`, '');
                 displayError(`pgStop${eventNumber}`, '');
                 displayError(`fuelUsedFrom${eventNumber}`, '');
             });
        }
        return allValid;
    }

     function addEventField(eventNumber) {
         const nowFormatted = getCurrentDateTimeLocal();
         const suffix = (eventNumber === 1) ? 'st' : (eventNumber === 2) ? 'nd' : (eventNumber === 3) ? 'rd' : 'th';
         const eventCardHtml = `
            <div class="card event-card" data-event-number="${eventNumber}" style="display:none;">
              <div class="card-content">
                <span class="card-title">${eventNumber}${suffix} Event
                    ${eventNumber > 1 ? '<button type="button" class="btn-floating waves-effect waves-light red right remove-event-btn"><i class="material-icons">remove_circle_outline</i></button>' : ''}
                </span>
                <div class="input-field">
                   <input type="datetime-local" id="pgStart${eventNumber}" name="pgStart${eventNumber}" class="input-material" max="${nowFormatted}" />
                   <label for="pgStart${eventNumber}" class="active">PG Start Date & Time</label>
                   <span class="error-message" id="pgStart${eventNumber}-error"></span>
                </div>
                <div class="input-field">
                   <input type="datetime-local" id="pgStop${eventNumber}" name="pgStop${eventNumber}" class="input-material" max="${nowFormatted}" />
                   <label for="pgStop${eventNumber}" class="active">PG Stop Date & Time</label>
                   <span class="error-message" id="pgStop${eventNumber}-error"></span>
                </div>
                <div class="input-field">
                   <select id="fuelUsedFrom${eventNumber}" name="fuelUsedFrom${eventNumber}"></select>
                   <label for="fuelUsedFrom${eventNumber}" class="active select-label">Fuel Used From</label>
                   <span class="error-message" id="fuelUsedFrom${eventNumber}-error"></span>
                </div>
              </div>
            </div>
          `;
         $('#pgEventsContainer').append(eventCardHtml);
         const newCard = $(`[data-event-number="${eventNumber}"]`);
         newCard.slideDown(300);
         eventCount++;

         const eventCard = $(`[data-event-number="${eventNumber}"]`);
         const newFuelDropdown = $(`#fuelUsedFrom${eventNumber}`);

         newFuelDropdown.empty().append('<option value="" disabled selected>Select fuel source</option>');
         employeeData.forEach(item => {
             if (item) newFuelDropdown.append(new Option(item, item));
         });
         console.log(`Populated #fuelUsedFrom${eventNumber} from stored data.`); // Matches example log

         newFuelDropdown.select2({
              placeholder: 'Select fuel source...',
              allowClear: true,
              dropdownParent: eventCard.find('.card-content')
         }).val(null).trigger('change');

         M_updateTextFields();

         $(`#pgStart${eventNumber}, #pgStop${eventNumber}, #fuelUsedFrom${eventNumber}`).on('change blur', validateAllConditionalFields);

         if (eventNumber > 1) {
              eventCard.find('.remove-event-btn').on('click', function() {
                  $(this).closest('.event-card').slideUp(300, function() {
                    $(this).remove();
                    eventCount--;
                    updateEventNumbers();
                    validateAllConditionalFields();
                    $('#addEventBtn').toggle(eventCount < MAX_EVENTS).css('display', eventCount < MAX_EVENTS ? 'inline-flex' : 'none');
                  });
              });
         }
         $('#addEventBtn').toggle(eventCount < MAX_EVENTS).css('display', eventCount < MAX_EVENTS ? 'inline-flex' : 'none');
         console.log(`Added Event ${eventNumber}. Total events: ${eventCount}`); // Matches example log
     }

     function updateEventNumbers() {
         $('#pgEventsContainer .event-card').each(function(index) {
             const newEventNumber = index + 1;
             const suffix = (newEventNumber === 1) ? 'st' : (newEventNumber === 2) ? 'nd' : (newEventNumber === 3) ? 'rd' : 'th';
             const card = $(this);
             const oldEventNumber = parseInt(card.data('event-number'));
             if (oldEventNumber === newEventNumber) return;

             card.data('event-number', newEventNumber);
             card.attr('data-event-number', newEventNumber); // Update attribute as well
             card.find('.card-title').contents().filter(function() {
                 return this.nodeType === 3; // Text node
             }).first().replaceWith(`${newEventNumber}${suffix} Event`);

             // Update IDs and names for inputs, labels, and error messages
             card.find('input, select, label, span.error-message').each(function() {
                 const el = $(this);
                 ['id', 'name', 'for'].forEach(attr => {
                     const oldVal = el.attr(attr);
                     if (oldVal && oldVal.includes(oldEventNumber)) {
                         // Use a regex to replace only the event number, avoiding false positives like "pgStart10" if "1" is replaced
                         const newVal = oldVal.replace(new RegExp(oldEventNumber + '(?![0-9])', 'g'), newEventNumber);
                         el.attr(attr, newVal);
                     }
                 });
             });

             // Re-initialize select2 for the moved/renamed dropdown
             const fuelSelect = card.find(`select[id^="fuelUsedFrom"]`);
             if (fuelSelect.data('select2')) {
                 fuelSelect.select2('destroy');
             }
             fuelSelect.select2({
                  placeholder: 'Select fuel source...',
                  allowClear: true,
                  dropdownParent: card.find('.card-content') // Ensure dropdown stays within card
             });

             // Ensure remove button is only present for eventNumber > 1
             const removeBtn = card.find('.remove-event-btn');
             if (newEventNumber > 1 && !removeBtn.length) {
                 card.find('.card-title').append('<button type="button" class="btn-floating waves-effect waves-light red right remove-event-btn"><i class="material-icons">remove_circle_outline</i></button>');
                 card.find('.remove-event-btn').on('click', function() {
                     $(this).closest('.event-card').slideUp(300, function() {
                       $(this).remove();
                       eventCount--;
                       updateEventNumbers();
                       validateAllConditionalFields();
                       $('#addEventBtn').toggle(eventCount < MAX_EVENTS).css('display', eventCount < MAX_EVENTS ? 'inline-flex' : 'none');
                     });
                 });
             } else if (newEventNumber === 1 && removeBtn.length) {
                 removeBtn.remove();
             }
         });
         M_updateTextFields();
     }


    async function fetchAndPopulateDropdown(dropdownId, sheetName, columnName, placeholderText) {
        const dropdown = $(`#${dropdownId}`);
        if (!dropdown.length) return;
        console.log(`Fetching for #${dropdownId} from ${sheetName}/${columnName}`); // Matches example log (Workspaceing -> Fetching)
        dropdown.empty().append(`<option value="" disabled selected>${placeholderText}</option>`);
        try {
            const response = await fetch('/.netlify/functions/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ type: 'getDropdownData', sheet: sheetName, column: columnName })
            });
            if (!response.ok) throw new Error(`Fetch failed: ${response.status} for ${columnName}`);
            const result = await response.json();
            if (result && result.success && Array.isArray(result.data)) {
                if (sheetName === 'Employees' && columnName === 'Employee_Code' && employeeData.length === 0) {
                    employeeData = result.data.filter(item => item);
                    console.log(`Stored Employee Data: (${employeeData.length})`, employeeData); // Matches example log
                }
                result.data.forEach(item => {
                    if (item) dropdown.append(new Option(item, item));
                });
                console.log(`Populated #${dropdownId}.`); // Matches example log
            } else {
                throw new Error(result.error || `Invalid data format for ${columnName}.`);
            }
        } catch (error) {
            console.error(`Error for #${dropdownId} (${columnName}):`, error);
            displayMessage('submissionStatus', `Failed to load ${columnName.replace('_', ' ')}. Please try refreshing.`, true);
        } finally {
            if (dropdown.hasClass('select2-hidden-accessible')) {
                dropdown.select2('destroy');
            }
            dropdown.select2({
                placeholder: placeholderText,
                allowClear: true,
                dropdownParent: dropdown.closest('.input-field')
            });
        }
    }

    async function initializeForm() {
        console.log("Initializing form features..."); // Matches example log
        $('#loggedInUserDisplay').text(`Logged in as: ${loggedInUsername}`);
        await Promise.all([
            fetchAndPopulateDropdown('siteDropdown', 'Sites', 'Site_Code', 'Select Site'),
            fetchAndPopulateDropdown('pgOperatorDropdown', 'Employees', 'Employee_Code', 'Select PG Operator Name'),
            fetchAndPopulateDropdown('teamLeaderDropdown', 'Employees', 'Team_Leader_Name', 'Select Team Leader Name')
        ]);
        M_updateTextFields();

        // Set current date for siteAttendDateTime, if any
        const nowFormatted = getCurrentDateTimeLocal();
        $('#siteAttendDateTime').attr('max', nowFormatted);
        $('#pgStart1').attr('max', nowFormatted);
        $('#pgStop1').attr('max', nowFormatted);
        // Initially add one event field for PG Run
        if (eventCount === 0) {
             addEventField(1);
        }
        $('#addEventBtn').toggle(eventCount < MAX_EVENTS);
    }

    // --- Event Listeners ---
    $('#selectOption').on('change', function() {
        const selectedOption = $(this).val();
        $('#misscallTTFields').slideUp(300);
        $('#pgRunFields').slideUp(300);
        $('#addEventBtn').hide();
        $('#pgEventsContainer').empty();
        eventCount = 0; // Reset event count

        if (selectedOption === 'Misscall TT') {
            $('#misscallTTFields').slideDown(300);
        } else if (selectedOption === 'PG Run') {
            $('#pgRunFields').slideDown(300, function() {
                 addEventField(1); // Add the first event field
                 $('#addEventBtn').show();
            });
        }
        validateAllConditionalFields();
        M_updateTextFields();
    });

    $('#siteAttend').on('change', function() {
        const siteAttend = $(this).val();
        if (siteAttend === 'YES') {
            $('#siteAttendDateTimeField').slideDown(300);
            $('#siteAttendDateTime').val(getCurrentDateTimeLocal());
        } else {
            $('#siteAttendDateTimeField').slideUp(300);
            $('#siteAttendDateTime').val('');
        }
        validateAllConditionalFields();
        M_updateTextFields();
    });

    $('#addEventBtn').on('click', function() {
        if (eventCount < MAX_EVENTS) {
            addEventField(eventCount + 1);
        } else {
            displayMessage('submissionStatus', `You can add a maximum of ${MAX_EVENTS} events.`, true);
        }
    });

    // Delegated event listener for remove buttons, as they are added dynamically
    $('#pgEventsContainer').on('click', '.remove-event-btn', function() {
        $(this).closest('.event-card').slideUp(300, function() {
            $(this).remove();
            eventCount--;
            updateEventNumbers();
            validateAllConditionalFields();
            $('#addEventBtn').toggle(eventCount < MAX_EVENTS).css('display', eventCount < MAX_EVENTS ? 'inline-flex' : 'none');
        });
    });

    $('#pgForm').on('submit', async function(e) {
        e.preventDefault();
        $('.primary-submit-btn').prop('disabled', true);
        $('#submissionStatus').hide().text('');
        $('.progress-bar.loading').show();

        let formValid = true;
        // Validate main fields
        if (!validateField('ttNumber', 'TT Number is mandatory and must be 7 digits.')) formValid = false;
        if ($('#ttNumber').val().length !== 7) { displayError('ttNumber', 'TT Number must be 7 digits.'); formValid = false; }
        if (!validateField('operatorName')) formValid = false;
        if (!validateField('siteDropdown')) formValid = false;
        if (!validateField('pgOperatorDropdown')) formValid = false;
        if (!validateField('teamLeaderDropdown')) formValid = false;
        if (!validateField('selectOption')) formValid = false;

        // Validate conditional fields
        if (!validateAllConditionalFields()) formValid = false;

        if (!formValid) {
            displayMessage('submissionStatus', 'Please correct the errors in the form.', true);
            $('.primary-submit-btn').prop('disabled', false);
            $('.progress-bar.loading').hide();
            $('html, body').animate({
                scrollTop: $('.error-message:visible').first().offset().top - 100
            }, 500);
            return;
        }

        const formData = {
            ttNumber: $('#ttNumber').val(),
            operatorName: $('#operatorName').val(),
            site: $('#siteDropdown').val(),
            pgOperator: $('#pgOperatorDropdown').val(),
            teamLeader: $('#teamLeaderDropdown').val(),
            selectOption: $('#selectOption').val(),
            entryBy: loggedInUsername,
            submissionDateTime: new Date().toISOString()
        };

        if (formData.selectOption === 'Misscall TT') {
            formData.siteAttend = $('#siteAttend').val();
            if (formData.siteAttend === 'YES') {
                formData.siteAttendDateTime = $('#siteAttendDateTime').val();
            }
        } else if (formData.selectOption === 'PG Run') {
            formData.pgEvents = [];
            $('#pgEventsContainer .event-card').each(function() {
                const eventNumber = $(this).data('event-number');
                formData.pgEvents.push({
                    pgStart: $(`#pgStart${eventNumber}`).val(),
                    pgStop: $(`#pgStop${eventNumber}`).val(),
                    fuelUsedFrom: $(`#fuelUsedFrom${eventNumber}`).val()
                });
            });
        }

        console.log("Submitting form data:", formData); // Matches example log

        try {
            const response = await fetch('/.netlify/functions/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ type: 'submitFormData', data: formData })
            });

            const result = await response.json();
            $('.primary-submit-btn').prop('disabled', false);
            $('.progress-bar.loading').hide();

            if (result.success) {
                displayMessage('submissionStatus', 'Form submitted successfully!', false);
                $('#pgForm')[0].reset();
                $('select').val(null).trigger('change'); // Clear select2 fields
                $('#pgEventsContainer').empty();
                eventCount = 0; // Reset event counter
                $('#addEventBtn').hide();
                $('#misscallTTFields, #pgRunFields, #siteAttendDateTimeField').hide();
                M_updateTextFields(); // Reset labels
                addEventField(1); // Add back the first event field for PG Run, hidden
            } else {
                displayMessage('submissionStatus', `Submission failed: ${result.error || 'Unknown error.'}`, true);
            }
        } catch (error) {
            console.error('Submission Error:', error);
            displayMessage('submissionStatus', `An error occurred: ${error.message}`, true);
            $('.primary-submit-btn').prop('disabled', false);
            $('.progress-bar.loading').hide();
        }
    });

    // --- Login Form Logic ---
    $('#loginForm').on('submit', async function(e) {
        e.preventDefault();
        const username = $('#username').val();
        const password = $('#password').val();
        const loginStatus = $('#login-status');
        const loginButton = $(this).find('button[type="submit"]');

        function displayLoginError(elementId, message, isError = true) {
            const el = $(`#${elementId}`);
            if (el.length) {
                el.text(message).removeClass('success error').addClass(isError ? 'error' : 'success').fadeIn();
                setTimeout(() => el.fadeOut(), 5000);
            }
        }

        loginButton.prop('disabled', true);
        loginStatus.hide().text(''); // Clear previous messages

        console.log("Attempting login..."); // Matches example log
        try {
            const response = await fetch('/.netlify/functions/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ type: 'login', username, password })
            });

            // Parse JSON even if response is not ok to get error message
            const result = await response.json();

            loginButton.prop('disabled', false);

            if (response.ok && result.success) {
                displayLoginError('login-status', 'Login successful!', false);
                loggedInUsername = username;
                setTimeout(() => {
                    $('#loginContainer').parent('.login-page-wrapper').fadeOut(400, function() {
                        $('#mainContent').fadeIn(400); // Show main content wrapper
                        initializeForm();
                        $('html, body').animate({ scrollTop: 0 }, 'fast');
                    });
                }, 1000);
            } else {
                displayLoginError('login-status', result.error || 'Invalid username or password.');
                $('#password').val('');
                M_updateTextFields();
            }
        } catch (error) {
            loginButton.prop('disabled', false);
            displayLoginError('login-status', 'Login failed: ' + error.message);
            $('#password').val('');
            M_updateTextFields();
            console.error("Login Fetch Error:", error);
        }
    });

    // --- Report Functionality ---
    $('#showFormBtn').on('click', function() {
      $('#reportContainer').hide();
      $('#formContainer').fadeIn(300);
      $(this).addClass('active-tab');
      $('#showReportBtn').removeClass('active-tab');
    });

    $('#showReportBtn').on('click', function() {
      $('#formContainer').hide();
      $('#reportContainer').fadeIn(300);
      $(this).addClass('active-tab');
      $('#showFormBtn').removeClass('active-tab');
      $('#reportResults').hide(); // Hide previous results when switching tabs
      $('#exportExcelBtn').hide();
      $('#reportStatus').hide().text('');
      // Set default dates for report
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      $('#startDate').val(firstDayOfMonth.toISOString().slice(0, 10));
      $('#endDate').val(today.toISOString().slice(0, 10));
      M_updateTextFields();
    });

    function validateReportDates() {
        let valid = true;
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        displayError('startDate', '');
        displayError('endDate', '');

        if (!startDate) {
            displayError('startDate', 'Start Date is mandatory.');
            valid = false;
        }
        if (!endDate) {
            displayError('endDate', 'End Date is mandatory.');
            valid = false;
        }

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start > end) {
                displayError('startDate', 'Start Date cannot be after End Date.');
                valid = false;
            }
        }
        return valid;
    }

    $('#generateReportBtn').on('click', async function() {
        if (!validateReportDates()) {
            displayMessage('reportStatus', 'Please correct the date errors.', true);
            return;
        }

        $('#reportLoading').show();
        $('#reportResults').hide();
        $('#exportExcelBtn').hide();
        $('#reportStatus').hide().text('');
        $(this).prop('disabled', true);

        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        try {
            const response = await fetch('/.netlify/functions/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ type: 'getReportData', startDate, endDate })
            });

            const result = await response.json();
            $('#reportLoading').hide();
            $(this).prop('disabled', false);

            if (response.ok && result.success) {
                populateReportTable(result.data);
                if (result.data.length > 0) {
                    $('#reportResults').fadeIn(300);
                    $('#exportExcelBtn').fadeIn(300);
                    displayMessage('reportStatus', `Report generated successfully. Found ${result.data.length} records.`, false);
                } else {
                    displayMessage('reportStatus', 'No records found for the selected date range.', false);
                }
            } else {
                displayMessage('reportStatus', `Failed to generate report: ${result.error || 'Unknown error.'}`, true);
            }
        } catch (error) {
            console.error('Report Generation Error:', error);
            displayMessage('reportStatus', `An error occurred: ${error.message}`, true);
            $('#reportLoading').hide();
            $(this).prop('disabled', false);
        }
    });

    function populateReportTable(data) {
        const tbody = $('#reportTable tbody');
        tbody.empty(); // Clear existing rows

        if (!data || data.length === 0) {
            tbody.append('<tr><td colspan="13" style="text-align: center;">No data available.</td></tr>');
            return;
        }

        data.forEach(record => {
            let rowHtml = `<tr>
                <td>${record.Date || ''}</td>
                <td>${record['TT Number'] || ''}</td>
                <td>${record.Operator || ''}</td>
                <td>${record.Site || ''}</td>
                <td>${record['PG Operator'] || ''}</td>
                <td>${record['Team Leader'] || ''}</td>
                <td>${record['Option Selected'] || ''}</td>
                <td>${record['Site Attend'] || ''}</td>
                <td>${record['Site Attend DT'] || ''}</td>
                <td>${record['PG Start DT'] || ''}</td>
                <td>${record['PG Stop DT'] || ''}</td>
                <td>${record['Fuel Used From'] || ''}</td>
                <td>${record['Entry By'] || ''}</td>
            </tr>`;
            tbody.append(rowHtml);
        });
    }

    $('#exportExcelBtn').on('click', function() {
        const table = document.getElementById('reportTable');
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report Data");
        const today = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `PG_Run_Report_${today}.xlsx`);
    });

    // Initial setup
    $('#formContainer').hide();
    $('#mainContent').hide(); // Hide main content initially
    $('.login-page-wrapper').show();
    M_updateTextFields(); // Apply material design effects on load
  });
</script>
</body>
</html>