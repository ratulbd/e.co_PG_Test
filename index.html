<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E.CO PG Run Data Collection Form - MPL</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
</head>
<body>

<div class="login-page-wrapper">
  <div class="login-container" id="loginContainer">
    <div class="login-header">
      <i class="material-icons login-icon">shield</i>
      <h2>E.CO PG Run</h2>
      <h2>Login</h2>
    </div>
    <form id="loginForm">
      <div class="input-field">
        <i class="material-icons prefix">account_circle</i>
        <input type="text" id="username" name="username" required>
        <label for="username">Username</label>
        <span class="error-message" id="username-error"></span>
      </div>

      <div class="input-field">
        <i class="material-icons prefix">lock</i>
        <input type="password" id="password" name="password" required>
        <label for="password">Password</label>
        <span class="error-message" id="password-error"></span>
      </div>

      <button type="submit" class="btn waves-effect waves-light login-btn"><i class="material-icons left">login</i>Login</button>
      <div class="login-message" id="login-status"></div>
    </form>
  </div>
</div>

<div id="optionsContainer" class="container" style="display: none; text-align: center; padding-top: 50px;">
    <div class="form-header">
        <h2>Welcome <span id="loggedInUserDisplayOptions"></span>!</h2>
    </div>
    <div class="card" style="margin-top: 40px; padding: 40px;">
        <div class="card-content">
            <h3>Choose an Option:</h3>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
                <button type="button" id="dataEntryOptionBtn" class="btn waves-effect waves-light large-option-btn">
                    <i class="material-icons left">edit</i>Data Entry
                </button>
                <button type="button" id="reportOptionBtn" class="btn waves-effect waves-light large-option-btn">
                    <i class="material-icons left">bar_chart</i>Report
                </button>
            </div>
        </div>
    </div>
</div>


<div id="formContainer" style="display: none;">
  <div class="container">
    <div class="form-header">
        <h2>E.CO PG Run Data Collection Form-MPL</h2>
        <span id="loggedInUserDisplayForm" class="logged-in-user"></span>
        <button type="button" id="backToOptionsBtnFromForm" class="btn waves-effect waves-light secondary-btn"><i class="material-icons left">arrow_back</i>Back to Options</button>
    </div>
    <form id="pgForm" novalidate>
      <div class="card">
        <div class="card-content">
          <div class="input-field">
            <input type="text" id="ttNumber" name="ttNumber" maxlength="7" inputmode="numeric">
            <label for="ttNumber">TT Number (7 digits)</label>
            <span class="error-message" id="ttNumber-error"></span>
          </div>

          <div class="input-field">
            <select id="operatorName" name="operatorName">
              <option value="" disabled selected>Select an operator</option>
              <option value="GP">GP</option>
              <option value="BL">BL</option>
              <option value="ROBI">ROBI</option>
            </select>
            <label for="operatorName" class="active select-label">Operator Name</label>
            <span class="error-message" id="operatorName-error"></span>
          </div>

          <div class="input-field">
            <select id="siteDropdown" name="site"></select>
            <label for="siteDropdown" class="active select-label">Select Site</label>
            <span class="error-message" id="siteDropdown-error"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-content">
          <div class="input-field">
            <select id="pgOperatorDropdown" name="pgOperator"></select>
            <label for="pgOperatorDropdown" class="active select-label">Select PG Operator Name</label>
            <span class="error-message" id="pgOperatorDropdown-error"></span>
          </div>

          <div class="input-field">
            <select id="teamLeaderDropdown" name="teamLeader"></select>
            <label for="teamLeaderDropdown" class="active select-label">Select Team Leader Name</label>
            <span class="error-message" id="teamLeaderDropdown-error"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-content">
          <div class="input-field">
            <select id="selectOption" name="selectOption">
              <option value="" disabled selected>Select an option</option>
              <option value="Misscall TT">Misscall TT</option>
              <option value="PG Run">PG Run</option>
            </select>
            <label for="selectOption" class="active select-label">Select Option</label>
            <span class="error-message" id="selectOption-error"></span>
          </div>
        </div>
      </div>

      <div id="misscallTTFields" style="display: none;" class="conditional-section">
        <div class="card">
          <div class="card-content">
            <div class="input-field">
              <select id="siteAttend" name="siteAttend">
                <option value="" disabled selected>Select an option</option>
                <option value="YES">YES</option>
                <option value="NO">NO</option>
              </select>
              <label for="siteAttend" class="active select-label">Site Attend</label>
              <span class="error-message" id="siteAttend-error"></span>
            </div>
          </div>
        </div>
        <div id="siteAttendDateTimeField" style="display: none;">
           <div class="card">
             <div class="card-content">
               <div class="input-field">
                 <input type="datetime-local" id="siteAttendDateTime" name="siteAttendDateTime" class="input-material" />
                 <label for="siteAttendDateTime" class="active">Site Attend Date & Time</label>
                 <span class="error-message" id="siteAttendDateTime-error"></span>
               </div>
             </div>
           </div>
        </div>
      </div>

      <div id="pgRunFields" style="display: none;" class="conditional-section">
        <div id="pgEventsContainer">
          </div>
        <div class="add-event-wrapper">
            <button type="button" id="addEventBtn" class="btn waves-effect waves-light add-button" style="display: none;"><i class="material-icons left">add_circle_outline</i>Add Event</button>
        </div>
      </div>

       <button type="submit" class="btn waves-effect waves-light primary-submit-btn"><i class="material-icons left">send</i>Submit</button>
        <div class="progress-bar loading" style="display: none;">
            <div class="indeterminate"></div>
        </div>
        <div id="submissionStatus" class="submission-status-message" style="display: none;"></div>
    </form>
  </div>
</div>

<div id="reportContainer" class="container" style="display: none;">
    <div class="form-header">
        <h2>Report Viewer</h2>
        <button type="button" id="backToOptionsBtnFromReport" class="btn waves-effect waves-light secondary-btn"><i class="material-icons left">arrow_back</i>Back to Options</button>
    </div>
    <div class="card">
        <div class="card-content">
            <div class="input-field">
                <input type="date" id="reportStartDate" name="reportStartDate" class="input-material">
                <label for="reportStartDate" class="active">Start Date</label>
            </div>
            <div class="input-field">
                <input type="date" id="reportEndDate" name="reportEndDate" class="input-material">
                <label for="reportEndDate" class="active">End Date</label>
            </div>
            <div class="input-field">
                <input type="text" id="reportTtNumber" name="reportTtNumber" maxlength="7" inputmode="numeric">
                <label for="reportTtNumber">TT Number</label>
                <span class="error-message" id="reportTtNumber-error"></span>
            </div>
            <div class="input-field">
                <select id="reportOperatorName" name="reportOperatorName">
                    <option value="" disabled selected>Select an operator</option>
                    <option value="All">All Operators</option>
                    <option value="GP">GP</option>
                    <option value="BL">BL</option>
                    <option value="ROBI">ROBI</option>
                </select>
                <label for="reportOperatorName" class="active select-label">Operator Name</label>
            </div>
            <div class="input-field">
                <select id="reportSiteDropdown" name="reportSiteDropdown"></select>
                <label for="reportSiteDropdown" class="active select-label">Select Site</label>
            </div>
            <div class="input-field">
                <select id="reportPgOperatorDropdown" name="reportPgOperatorDropdown"></select>
                <label for="reportPgOperatorDropdown" class="active select-label">Select PG Operator Name</label>
            </div>
            <div class="input-field">
                <select id="reportTeamLeaderDropdown" name="reportTeamLeaderDropdown"></select>
                <label for="reportTeamLeaderDropdown" class="active select-label">Select Team Leader Name</label>
            </div>
            <div class="input-field">
                <select id="reportSelectOption" name="reportSelectOption">
                    <option value="" disabled selected>Select an option</option>
                    <option value="All">All Types</option>
                    <option value="Misscall TT">Misscall TT</option>
                    <option value="PG Run">PG Run</option>
                </select>
                <label for="reportSelectOption" class="active select-label">Select Option</label>
            </div>
            <button type="button" id="generateReportBtn" class="btn waves-effect waves-light primary-submit-btn"><i class="material-icons left">search</i>Generate Report</button>
            <button type="button" id="exportReportBtn" class="btn waves-effect waves-light secondary-btn" style="display: none;"><i class="material-icons left">download</i>Export to Excel</button>
        </div>
    </div>

    <div id="reportResults" style="display: none;">
        <h3>Report Data</h3>
        <div class="report-table-container">
            <table id="reportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>TT Number</th>
                        <th>Operator</th>
                        <th>Site</th>
                        <th>PG Operator</th>
                        <th>Team Leader</th>
                        <th>Type</th>
                        <th>Site Attend</th>
                        <th>Site Attend Date/Time</th>
                        <th>PG Start</th>
                        <th>PG Stop</th>
                        <th>Fuel Used From</th>
                        <th>Total Fuel Used</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <p id="noReportDataMessage" style="display: none; text-align: center; color: var(--label-color);">No data available for the selected criteria.</p>
    </div>
</div>


<div class="footer-info">
  <p>Powered and Developed By<br>
  <strong>Rakibul Islam Ratul</strong><br>
  <small>Sr. Manager, Central Governance, Metal Plus Ltd.</small></p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
  $(document).ready(function () {
    const MAX_EVENTS = 10;
    let eventCount = 0;
    let loggedInUsername = '';
    let employeeData = []; // To store PG Operator and Team Leader data

    function M_updateTextFields() {
        $('input[type=text], input[type=password], input[type=email], input[type=url], input[type=tel], input[type=number], input[type=search], textarea').each(function (index, element) {
            const $this = $(element);
            const $label = $this.siblings('label');
            if ($this.val().length > 0 || $this.attr('placeholder') !== undefined || $this.is(':focus')) {
                $label.addClass('active');
            } else if (!$this.is('[readonly]')) {
                $label.removeClass('active');
            }
        });
        $('select').each(function() {
            const $this = $(this);
            const $label = $this.siblings('label.select-label');
            if ($this.val() && $this.val() !== "") {
                 $label.addClass('active');
            }
        });
    }


    function getCurrentDateTimeLocal() {
        const now = new Date();
        const tzOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - tzOffset)).toISOString().slice(0, 16);
        return localISOTime;
    }

    function parseDateTime(datetimeStr) {
        if (!datetimeStr) return null;
        const date = new Date(datetimeStr);
        return isNaN(date.getTime()) ? null : date;
    }

    function displayMessage(elementId, message, isError) {
        const el = $(`#${elementId}`);
        if (el.length) {
            el.text(message).removeClass('success error').addClass(isError ? 'error' : 'success').fadeIn();
            if(isError && elementId === 'submissionStatus') {
                 setTimeout(() => el.fadeOut(), 5000);
            } else if (!isError && elementId === 'submissionStatus') {
                 setTimeout(() => el.fadeOut(), 3000);
            }
        }
    }

    function displayError(fieldId, message) {
        const errorSpan = $(`#${fieldId}-error`);
        const fieldElement = $(`#${fieldId}`);
        if (!fieldElement.length) return;

        if (message) {
            if (errorSpan.length) errorSpan.text(message).show();
            fieldElement.addClass('invalid');
            if (fieldElement.is('select') && fieldElement.data('select2')) {
                 fieldElement.next('.select2-container').find('.select2-selection--single').addClass('invalid-select2');
            }
        } else {
            if (errorSpan.length) errorSpan.text('').hide();
            fieldElement.removeClass('invalid');
            if (fieldElement.is('select') && fieldElement.data('select2')) {
                 fieldElement.next('.select2-container').find('.select2-selection--single').removeClass('invalid-select2');
            }
        }
    }

    $('#ttNumber').on('input', function() {
        let value = $(this).val();
        value = value.replace(/[^0-9]/g, '');
        if (value.length > 7) {
            value = value.slice(0, 7);
        }
        $(this).val(value);
        displayError('ttNumber', '');
    });

    $('#reportTtNumber').on('input', function() {
        let value = $(this).val();
        value = value.replace(/[^0-9]/g, '');
        if (value.length > 7) {
            value = value.slice(0, 7);
        }
        $(this).val(value);
        displayError('reportTtNumber', '');
    });


    function validateField(fieldId, customMessage = 'This field is mandatory.') {
        const value = $(`#${fieldId}`).val();
        if (!value || (Array.isArray(value) && value.length === 0)) {
            displayError(fieldId, customMessage);
            return false;
        } else {
            displayError(fieldId, '');
            return true;
        }
    }

    function validateAllConditionalFields() {
        const selectOption = $('#selectOption').val();
        let allValid = true;

        if (selectOption === 'Misscall TT' && $('#misscallTTFields').is(':visible')) {
            if (!validateField('siteAttend')) allValid = false;
            const siteAttend = $('#siteAttend').val();
            if (siteAttend === 'YES' && $('#siteAttendDateTimeField').is(':visible')) {
                const siteAttendDateTimeVal = $('#siteAttendDateTime').val();
                if (!siteAttendDateTimeVal) {
                    displayError('siteAttendDateTime', 'Date & Time is mandatory when Site Attend is YES.');
                    allValid = false;
                } else {
                    const siteAttendDateTime = parseDateTime(siteAttendDateTimeVal);
                    const now = new Date();
                    if (!siteAttendDateTime || siteAttendDateTime > now) {
                         displayError('siteAttendDateTime', 'Invalid or future date/time.');
                         allValid = false;
                    } else {
                        displayError('siteAttendDateTime', '');
                    }
                }
            } else {
                 displayError('siteAttendDateTime', '');
            }
        } else {
            displayError('siteAttend', '');
            displayError('siteAttendDateTime', '');
        }

        if (selectOption === 'PG Run' && $('#pgRunFields').is(':visible')) {
            let previousEventStop = null;
            if ($('#pgEventsContainer .event-card').length === 0 && eventCount > 0) {
            }
            $('#pgEventsContainer .event-card').each(function(index) {
                const eventNumber = $(this).data('event-number');
                const pgStartId = `pgStart${eventNumber}`;
                const pgStopId = `pgStop${eventNumber}`;
                const fuelUsedFromId = `fuelUsedFrom${eventNumber}`;
                const pgStartVal = $(`#${pgStartId}`).val();
                const pgStopVal = $(`#${pgStopId}`).val();
                const fuelUsedFromVal = $(`#${fuelUsedFromId}`).val();
                const pgStart = parseDateTime(pgStartVal);
                const pgStop = parseDateTime(pgStopVal);
                const now = new Date();
                let currentEventValid = true;

                if (pgStartVal || pgStopVal || fuelUsedFromVal || index === 0) {
                    if (!pgStartVal) { displayError(pgStartId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(pgStartId, ''); }
                    if (!pgStopVal) { displayError(pgStopId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(pgStopId, ''); }
                    if (!fuelUsedFromVal) { displayError(fuelUsedFromId, 'Mandatory.'); allValid = false; currentEventValid = false; } else { displayError(fuelUsedFromId, ''); }

                    if (pgStart && pgStop) {
                        if (pgStop <= pgStart) { displayError(pgStopId, 'Stop time must be after Start time.'); allValid = false; currentEventValid = false; }
                        if (pgStart > now) { displayError(pgStartId, 'Start time cannot be in the future.'); allValid = false; currentEventValid = false; }
                        if (pgStop > now) { displayError(pgStopId, 'Stop time cannot be in the future.'); allValid = false; currentEventValid = false; }
                        if (previousEventStop && pgStart <= previousEventStop) { displayError(pgStartId, `Must be after Event ${index}'s Stop.`); allValid = false; currentEventValid = false; }

                        if (currentEventValid) {
                            previousEventStop = pgStop;
                        } else {
                            previousEventStop = null;
                        }
                    } else {
                        previousEventStop = null;
                    }
                } else {
                    displayError(pgStartId, '');
                    displayError(pgStopId, '');
                    displayError(fuelUsedFromId, '');
                }
            });
        } else {
            $('#pgEventsContainer .event-card').each(function() {
                const eventNumber = $(this).data('event-number');
                displayError(`pgStart${eventNumber}`, '');
                displayError(`pgStop${eventNumber}`, '');
                displayError(`fuelUsedFrom${eventNumber}`, '');
            });
        }
        return allValid;
    }

    function addEventField(eventNumber) {
        const nowFormatted = getCurrentDateTimeLocal();
        const suffix = (eventNumber === 1) ? 'st' : (eventNumber === 2) ? 'nd' : (eventNumber === 3) ? 'rd' : 'th';
        const eventCardHtml = `
            <div class="card event-card" data-event-number="${eventNumber}" style="display:none;">
                <div class="card-content">
                    <span class="card-title">${eventNumber}${suffix} Event ${eventNumber > 1 ? '<button type="button" class="btn-floating waves-effect waves-light red right remove-event-btn"><i class="material-icons">remove_circle_outline</i></button>' : ''} </span>
                    <div class="input-field">
                        <input type="datetime-local" id="pgStart${eventNumber}" name="pgStart${eventNumber}" class="input-material" max="${nowFormatted}" />
                        <label for="pgStart${eventNumber}" class="active">PG Start Date & Time</label>
                        <span class="error-message" id="pgStart${eventNumber}-error"></span>
                    </div>
                    <div class="input-field">
                        <input type="datetime-local" id="pgStop${eventNumber}" name="pgStop${eventNumber}" class="input-material" max="${nowFormatted}" />
                        <label for="pgStop${eventNumber}" class="active">PG Stop Date & Time</label>
                        <span class="error-message" id="pgStop${eventNumber}-error"></span>
                    </div>
                    <div class="input-field">
                        <select id="fuelUsedFrom${eventNumber}" name="fuelUsedFrom${eventNumber}" class="fuel-used-from-dropdown"></select>
                        <label for="fuelUsedFrom${eventNumber}" class="active select-label">Fuel Used From</label>
                        <span class="error-message" id="fuelUsedFrom${eventNumber}-error"></span>
                    </div>
                </div>
            </div> `;
        $('#pgEventsContainer').append(eventCardHtml);
        const newCard = $(`[data-event-number="${eventNumber}"]`);
        newCard.slideDown(300, function() {
            M_updateTextFields();
            // Populate the new fuel dropdown
            populateDropdown(`#fuelUsedFrom${eventNumber}`, employeeData.fuelUsedFrom, 'Select Fuel Source');
            $(`#fuelUsedFrom${eventNumber}`).select2({
                placeholder: 'Select Fuel Source',
                allowClear: true
            });
        });
        eventCount++;
    }


    async function fetchEmployeeAndSiteData() {
        try {
            console.log("Fetching employee and site data...");
            const response = await fetch('https://script.google.com/macros/s/AKfycbyn_zk2BaPTswVWHEDSXhCZkB5NisS9-3mx2uT807p7Tyn5oVAZ5UWpUsFKhy-rP4Lf/exec?action=getEmployeeAndSiteData');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Fetched data:", data);
            employeeData = data;

            populateDropdown('#siteDropdown', employeeData.sites, 'Select Site');
            populateDropdown('#pgOperatorDropdown', employeeData.pgOperators, 'Select PG Operator Name');
            populateDropdown('#teamLeaderDropdown', employeeData.teamLeaders, 'Select Team Leader Name');

            // Populate Fuel Used From dropdown for existing events if any (and future ones)
            // This needs to be called every time an event card is added or on form initialization
            $('.fuel-used-from-dropdown').each(function() {
                populateDropdown(this, employeeData.fuelUsedFrom, 'Select Fuel Source');
            });


            M_updateTextFields();
            $('select').each(function() {
                if ($(this).data('select2')) {
                    $(this).select2('destroy');
                }
                $(this).select2({
                    placeholder: $(this).find('option:first').text(),
                    allowClear: true
                });
            });

        } catch (error) {
            console.error("Error fetching employee and site data:", error);
            displayMessage('submissionStatus', 'Failed to load dropdown data. Please try again.', true);
        }
    }

    function populateDropdown(selector, data, defaultOptionText) {
        const $dropdown = $(selector);
        $dropdown.empty();
        $dropdown.append($('<option></option>').attr('value', '').text(defaultOptionText).prop('disabled', true).prop('selected', true));
        if (data && data.length > 0) {
            $.each(data, function (i, item) {
                $dropdown.append($('<option></option>').attr('value', item).text(item));
            });
        }
        $dropdown.trigger('change');
    }

    function initializeForm() {
        $('#loggedInUserDisplayForm').text(loggedInUsername);
        M_updateTextFields(); // Update labels for any pre-filled inputs
        fetchEmployeeAndSiteData(); // Fetch and populate dropdowns

        // Initialize Select2 for all select elements
        $('select').each(function() {
            if ($(this).attr('id') !== 'operatorName' && $(this).attr('id') !== 'reportOperatorName' && $(this).attr('id') !== 'selectOption' && $(this).attr('id') !== 'reportSelectOption' && $(this).attr('id') !== 'siteAttend') {
              $(this).select2({
                  placeholder: $(this).find('option:first').text(),
                  allowClear: true
              });
            }
        });
    }


    // Login Form Submission
    $('#loginForm').on('submit', function (e) {
        e.preventDefault();
        const username = $('#username').val();
        const password = $('#password').val();
        $(this).find('button[type="submit"]').prop('disabled', true);
        displayError('username', '');
        displayError('password', '');
        displayMessage('login-status', 'Logging in...', false);

        fetch('https://script.google.com/macros/s/AKfycbyn_zk2BaPTswVWHEDSXhCZkB5NisS9-3mx2uT807p7Tyn5oVAZ5UWpUsFKhy-rP4Lf/exec', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: 'login', username, password }),
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            $(this).find('button[type="submit"]').prop('disabled', false);
            if (!ok || !data.success) {
                throw new Error((data && data.error) || 'Invalid username or password.');
            }
            displayMessage('login-status', 'Login successful!', false);
            loggedInUsername = username;
            setTimeout(() => {
                $('#loginContainer').parent('.login-page-wrapper').fadeOut(400, function() {
                    $('#optionsContainer').fadeIn(400);
                    $('#loggedInUserDisplayOptions').text(loggedInUsername); // Set username for options page
                });
            }, 1000);
        })
        .catch(error => {
            $(this).find('button[type="submit"]').prop('disabled', false);
            displayMessage('login-status', 'Login failed: ' + error.message, true);
            $('#password').val('');
            M_updateTextFields();
            console.error("Login Fetch Error:", error);
        });
    });

    $('#loginContainer input').on('focus', function() { $(this).siblings('label').addClass('active'); });
    $('#loginContainer input').on('blur', function() { if ($(this).val() === '') $(this).siblings('label').removeClass('active');});

    // Option Buttons
    $('#dataEntryOptionBtn').on('click', function() {
        $('#optionsContainer').fadeOut(400, function() {
            $('#formContainer').fadeIn(400);
            $('#loggedInUserDisplayForm').text(loggedInUsername);
            initializeForm(); // Call initializeForm here to populate dropdowns for the data entry form
        });
    });

    $('#reportOptionBtn').on('click', function() {
        $('#optionsContainer').fadeOut(400, function() {
            $('#reportContainer').fadeIn(400);
             // Re-initialize Select2 for report dropdowns if needed, though initializeForm
             // might cover most. Specific report dropdowns like reportSiteDropdown,
             // reportPgOperatorDropdown, reportTeamLeaderDropdown also need data.
             // For simplicity, will reuse fetchEmployeeAndSiteData and populateDropdown
             // for report dropdowns.
             fetchEmployeeAndSiteDataForReport(); // New function for report dropdowns
        });
    });

    $('#backToOptionsBtnFromForm').on('click', function() {
        $('#formContainer').fadeOut(400, function() {
            $('#optionsContainer').fadeIn(400);
        });
    });

    $('#backToOptionsBtnFromReport').on('click', function() {
        $('#reportContainer').fadeOut(400, function() {
            $('#optionsContainer').fadeIn(400);
        });
    });


    // Conditional Fields Logic
    $('#selectOption').on('change', function() {
        const selectedOption = $(this).val();
        displayError('selectOption', '');
        if (selectedOption === 'Misscall TT') {
            $('#misscallTTFields').slideDown(300);
            $('#pgRunFields').slideUp(300);
            $('#addEventBtn').hide();
            // Clear PG Run fields when Misscall TT is selected
            $('#pgEventsContainer').empty();
            eventCount = 0;
        } else if (selectedOption === 'PG Run') {
            $('#misscallTTFields').slideUp(300);
            $('#pgRunFields').slideDown(300);
            $('#addEventBtn').show();
            // Clear Misscall TT fields when PG Run is selected
            $('#siteAttend').val('');
            $('#siteAttendDateTime').val('');
            $('#siteAttendDateTimeField').hide();
            M_updateTextFields();
        } else {
            $('#misscallTTFields').slideUp(300);
            $('#pgRunFields').slideUp(300);
            $('#addEventBtn').hide();
        }
    });

    $('#siteAttend').on('change', function() {
        const selectedValue = $(this).val();
        displayError('siteAttend', '');
        if (selectedValue === 'YES') {
            $('#siteAttendDateTime').val(getCurrentDateTimeLocal());
            $('#siteAttendDateTimeField').slideDown(300);
        } else {
            $('#siteAttendDateTime').val('');
            $('#siteAttendDateTimeField').slideUp(300);
        }
        M_updateTextFields();
    });

    $('#addEventBtn').on('click', function() {
        if (eventCount < MAX_EVENTS) {
            eventCount++;
            addEventField(eventCount);
        } else {
            alert(`You can add a maximum of ${MAX_EVENTS} events.`);
        }
    });

    $('#pgEventsContainer').on('click', '.remove-event-btn', function() {
        const eventCard = $(this).closest('.event-card');
        const eventNumberToRemove = eventCard.data('event-number');

        eventCard.slideUp(300, function() {
            $(this).remove();
            // Re-index remaining events and update titles
            eventCount = 0;
            $('#pgEventsContainer .event-card').each(function(index) {
                const newEventNumber = index + 1;
                $(this).data('event-number', newEventNumber);
                $(this).attr('data-event-number', newEventNumber); // Update attribute as well
                const suffix = (newEventNumber === 1) ? 'st' : (newEventNumber === 2) ? 'nd' : (newEventNumber === 3) ? 'rd' : 'th';
                $(this).find('.card-title').html(`${newEventNumber}${suffix} Event ${newEventNumber > 1 ? '<button type="button" class="btn-floating waves-effect waves-light red right remove-event-btn"><i class="material-icons">remove_circle_outline</i></button>' : ''}`);

                // Update IDs and names for inputs within the card
                $(this).find('[id^="pgStart"]').attr({
                    id: `pgStart${newEventNumber}`,
                    name: `pgStart${newEventNumber}`
                });
                $(this).find('[for^="pgStart"]').attr('for', `pgStart${newEventNumber}`);
                $(this).find('[id^="pgStop"]').attr({
                    id: `pgStop${newEventNumber}`,
                    name: `pgStop${newEventNumber}`
                });
                $(this).find('[for^="pgStop"]').attr('for', `pgStop${newEventNumber}`);
                $(this).find('[id^="fuelUsedFrom"]').attr({
                    id: `fuelUsedFrom${newEventNumber}`,
                    name: `fuelUsedFrom${newEventNumber}`
                });
                $(this).find('[for^="fuelUsedFrom"]').attr('for', `fuelUsedFrom${newEventNumber}`);
                $(this).find('[id$="-error"]').each(function() {
                    const oldId = $(this).attr('id');
                    const baseId = oldId.replace(/-\d+-error$/, '-error').replace(`-error`, '');
                    $(this).attr('id', `${baseId.replace(/\d+$/, newEventNumber)}-error`);
                });
                eventCount++;
            });
            M_updateTextFields(); // Re-activate labels after re-indexing
        });
    });

    // Form Submission
    $('#pgForm').on('submit', function (e) {
        e.preventDefault();
        displayMessage('submissionStatus', '', false);
        $('.loading').show();
        $(this).find('button[type="submit"]').prop('disabled', true);

        // Basic validation for main fields
        let formValid = true;
        if (!validateField('ttNumber', 'TT Number is mandatory and must be 7 digits.')) formValid = false;
        if ($('#ttNumber').val().length !== 7) {
            displayError('ttNumber', 'TT Number must be exactly 7 digits.');
            formValid = false;
        }
        if (!validateField('operatorName')) formValid = false;
        if (!validateField('siteDropdown')) formValid = false;
        if (!validateField('pgOperatorDropdown')) formValid = false;
        if (!validateField('teamLeaderDropdown')) formValid = false;
        if (!validateField('selectOption')) formValid = false;

        formValid = validateAllConditionalFields() && formValid;


        if (!formValid) {
            displayMessage('submissionStatus', 'Please correct the errors in the form.', true);
            $('.loading').hide();
            $(this).find('button[type="submit"]').prop('disabled', false);
            $('html, body').animate({
                scrollTop: $('.error-message:visible').first().offset().top - 100
            }, 'fast');
            return;
        }

        // Collect all form data
        const formData = {
            action: 'submitFormData',
            ttNumber: $('#ttNumber').val(),
            operatorName: $('#operatorName').val(),
            site: $('#siteDropdown').val(),
            pgOperator: $('#pgOperatorDropdown').val(),
            teamLeader: $('#teamLeaderDropdown').val(),
            selectOption: $('#selectOption').val(),
            loggedInUser: loggedInUsername, // Add logged-in username
        };

        if (formData.selectOption === 'Misscall TT') {
            formData.siteAttend = $('#siteAttend').val();
            if (formData.siteAttend === 'YES') {
                formData.siteAttendDateTime = $('#siteAttendDateTime').val();
            }
        } else if (formData.selectOption === 'PG Run') {
            formData.pgEvents = [];
            $('#pgEventsContainer .event-card').each(function() {
                const eventNumber = $(this).data('event-number');
                formData.pgEvents.push({
                    pgStart: $(`#pgStart${eventNumber}`).val(),
                    pgStop: $(`#pgStop${eventNumber}`).val(),
                    fuelUsedFrom: $(`#fuelUsedFrom${eventNumber}`).val()
                });
            });
        }
        console.log("Submitting Data:", formData);

        fetch('https://script.google.com/macros/s/AKfycbyn_zk2BaPTswVWHEDSXhCZkB5NisS9-3mx2uT807p7Tyn5oVAZ5UWxKjJv2i-rP4Lf/exec', { // Changed URL for testing
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
        .then(response => response.json())
        .then(data => {
            $('.loading').hide();
            $(this).find('button[type="submit"]').prop('disabled', false);
            if (data.result === 'success') {
                displayMessage('submissionStatus', 'Data submitted successfully!', false);
                $('#pgForm')[0].reset();
                $('.select2-container').each(function() {
                     $(this).removeClass('invalid-select2'); // Remove invalid styles from select2
                });
                $('select').val('').trigger('change'); // Reset all selects
                M_updateTextFields();
                $('#misscallTTFields').hide();
                $('#pgRunFields').hide();
                $('#pgEventsContainer').empty();
                eventCount = 0;
            } else {
                displayMessage('submissionStatus', 'Error submitting data: ' + data.error, true);
            }
        })
        .catch(error => {
            $('.loading').hide();
            $(this).find('button[type="submit"]').prop('disabled', false);
            displayMessage('submissionStatus', 'An error occurred: ' + error.message, true);
            console.error("Submission Fetch Error:", error);
        });
    });

    // Report Generation Logic
    async function fetchEmployeeAndSiteDataForReport() {
        try {
            console.log("Fetching employee and site data for report dropdowns...");
            const response = await fetch('https://script.google.com/macros/s/AKfycbyn_zk2BaPTswVWHEDSXhCZkB5NisS9-3mx2uT807p7Tyn5oVAZ5UWUa-oQ/exec?action=getEmployeeAndSiteData'); // Use the correct URL for report
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Fetched report data:", data);
            employeeData = data; // Assuming structure is same or similar

            // Populate report specific dropdowns
            populateDropdown('#reportSiteDropdown', ['All', ...employeeData.sites], 'Select Site');
            populateDropdown('#reportPgOperatorDropdown', ['All', ...employeeData.pgOperators], 'Select PG Operator Name');
            populateDropdown('#reportTeamLeaderDropdown', ['All', ...employeeData.teamLeaders], 'Select Team Leader Name');

            // Initialize Select2 for report dropdowns
            $('#reportContainer select').each(function() {
                if ($(this).attr('id') !== 'reportOperatorName' && $(this).attr('id') !== 'reportSelectOption') { // Exclude hardcoded dropdowns
                    $(this).select2({
                        placeholder: $(this).find('option:first').text(),
                        allowClear: true
                    });
                }
            });
            M_updateTextFields();
        } catch (error) {
            console.error("Error fetching report dropdown data:", error);
            // Optionally display a message to the user
        }
    }


    $('#generateReportBtn').on('click', function() {
        const startDate = $('#reportStartDate').val();
        const endDate = $('#reportEndDate').val();
        const ttNumber = $('#reportTtNumber').val();
        const operatorName = $('#reportOperatorName').val();
        const site = $('#reportSiteDropdown').val();
        const pgOperator = $('#reportPgOperatorDropdown').val();
        const teamLeader = $('#reportTeamLeaderDropdown').val();
        const selectOption = $('#reportSelectOption').val();

        if (ttNumber && ttNumber.length !== 7) {
             displayError('reportTtNumber', 'TT Number must be exactly 7 digits.');
             return;
        } else {
             displayError('reportTtNumber', '');
        }

        const reportCriteria = {
            action: 'getReportData',
            startDate: startDate,
            endDate: endDate,
            ttNumber: ttNumber,
            operatorName: operatorName === 'All' ? '' : operatorName,
            site: site === 'All' ? '' : site,
            pgOperator: pgOperator === 'All' ? '' : pgOperator,
            teamLeader: teamLeader === 'All' ? '' : teamLeader,
            selectOption: selectOption === 'All' ? '' : selectOption
        };

        // Example fetch for report data (assuming a different Google Script URL or action)
        fetch('https://script.google.com/macros/s/AKfycbyn_zk2BaPTswVWHEDSXhCZkB5NisS9-3mx2uT807p7Tyn5oVAZ5UWUa-oQ/exec', { // This URL should be distinct if it fetches report data
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reportCriteria),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.reportData) {
                renderReportTable(data.reportData);
            } else {
                renderReportTable([]); // Show empty table if no data or error
            }
        })
        .catch(error => {
            console.error("Error fetching report data:", error);
            renderReportTable([]); // Show empty table on error
            $('#noReportDataMessage').text('Error fetching report data.').show();
        });
    });

    function renderReportTable(data) {
        const tbody = $('#reportTable tbody');
        tbody.empty();
        $('#noReportDataMessage').hide();
        $('#exportReportBtn').hide();

        if (data && data.length > 0) {
            $.each(data, function(index, row) {
                let rowHtml = `<tr>
                                <td>${row.timestamp ? new Date(row.timestamp).toLocaleString() : ''}</td>
                                <td>${row.ttNumber || ''}</td>
                                <td>${row.operatorName || ''}</td>
                                <td>${row.site || ''}</td>
                                <td>${row.pgOperator || ''}</td>
                                <td>${row.teamLeader || ''}</td>
                                <td>${row.selectOption || ''}</td>
                                <td>${row.siteAttend || ''}</td>
                                <td>${row.siteAttendDateTime ? new Date(row.siteAttendDateTime).toLocaleString() : ''}</td>`;

                if (row.selectOption === 'PG Run' && row.pgEvents && row.pgEvents.length > 0) {
                    // For simplicity, showing only the first event details in the main row
                    const firstEvent = row.pgEvents[0];
                    rowHtml += `<td>${firstEvent.pgStart ? new Date(firstEvent.pgStart).toLocaleString() : ''}</td>
                                <td>${firstEvent.pgStop ? new Date(firstEvent.pgStop).toLocaleString() : ''}</td>
                                <td>${firstEvent.fuelUsedFrom || ''}</td>
                                <td>${calculateTotalFuel(row.pgEvents)}</td>`; // Calculate total fuel if needed
                } else {
                    rowHtml += `<td></td><td></td><td></td><td></td><td></td><td></td>`;
                }
                rowHtml += `</tr>`;
                tbody.append(rowHtml);
            });
            $('#reportResults').slideDown(300);
            $('#exportReportBtn').show();
        } else {
            $('#reportResults').slideUp(300);
            $('#noReportDataMessage').text('No data available for the selected criteria.').show();
        }
    }

    function calculateTotalFuel(pgEvents) {
        // This is a placeholder for actual fuel calculation logic
        // You would need 'fuel used' amount per event to sum it up.
        // For now, returning a placeholder string.
        if (!pgEvents || pgEvents.length === 0) return 'N/A';
        return 'Calculated Fuel'; // Replace with actual calculation
    }

    $('#exportReportBtn').on('click', function() {
        const wb = XLSX.utils.table_to_book(document.getElementById('reportTable'), { sheet: "Report" });
        XLSX.writeFile(wb, "E.CO_PG_Run_Report.xlsx");
    });
  });
</script>
</body>
</html>